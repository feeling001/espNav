# Project Structure

## Directory Layout

```
marine-gateway/
├── platformio.ini                 # PlatformIO configuration
├── partitions.csv                 # ESP32 partition table
├── README.md                      # Project README
├── build_and_flash.sh            # Build automation script
├── .gitignore
│
├── data/                          # Files to upload to LittleFS
│   └── www/                       # Web dashboard (React build output)
│       ├── index.html
│       ├── assets/
│       │   ├── index-[hash].js
│       │   └── index-[hash].css
│       └── favicon.ico
│
├── web-dashboard/                 # React dashboard source
│   ├── package.json
│   ├── package-lock.json
│   ├── vite.config.js
│   ├── index.html
│   ├── .gitignore
│   ├── build.sh                  # Build and copy to data/www
│   ├── public/
│   │   └── favicon.ico
│   └── src/
│       ├── main.jsx              # React entry point
│       ├── App.jsx               # Main app component
│       ├── components/
│       │   ├── Layout/
│       │   │   ├── Sidebar.jsx
│       │   │   └── Header.jsx
│       │   ├── WiFi/
│       │   │   ├── WiFiConfig.jsx
│       │   │   ├── NetworkScanner.jsx
│       │   │   └── ConnectionStatus.jsx
│       │   ├── Serial/
│       │   │   ├── SerialConfig.jsx
│       │   │   └── BaudRateSelector.jsx
│       │   ├── NMEA/
│       │   │   ├── NMEAMonitor.jsx
│       │   │   └── SentenceList.jsx
│       │   └── System/
│       │       ├── StatusPage.jsx
│       │       └── SystemInfo.jsx
│       ├── services/
│       │   ├── api.js            # REST API client
│       │   └── websocket.js      # WebSocket client
│       ├── hooks/
│       │   ├── useWebSocket.js
│       │   └── useConfig.js
│       ├── utils/
│       │   └── validators.js
│       └── styles/
│           └── main.css
│
├── include/                       # Header files
│   ├── config.h                  # Global constants and configuration
│   ├── types.h                   # Common type definitions
│   ├── uart_handler.h            # UART handler class
│   ├── nmea_parser.h             # NMEA parser class
│   ├── tcp_server.h              # TCP server class
│   ├── web_server.h              # Web server class
│   ├── config_manager.h          # Configuration manager class
│   └── wifi_manager.h            # WiFi manager class
│
├── src/                          # Implementation files
│   ├── main.cpp                  # Main entry point + FreeRTOS tasks
│   ├── uart_handler.cpp          # UART implementation
│   ├── nmea_parser.cpp           # NMEA parser implementation
│   ├── tcp_server.cpp            # TCP server implementation
│   ├── web_server.cpp            # Web server + API implementation
│   ├── config_manager.cpp        # Config persistence implementation
│   └── wifi_manager.cpp          # WiFi management implementation
│
├── lib/                          # Local libraries (optional)
│   └── README.md                 # Library documentation
│
├── test/                         # Unit tests (optional)
│   ├── test_nmea_parser.cpp
│   └── test_checksum.cpp
│
└── docs/                         # Additional documentation
    ├── API.md                    # REST API documentation
    ├── NMEA_FORMAT.md           # NMEA sentence format reference
    └── TROUBLESHOOTING.md       # Common issues and solutions
```

## File Descriptions

### Root Level

#### `platformio.ini`
PlatformIO project configuration file. Defines:
- Board type (ESP32-S3)
- Framework (Arduino)
- Library dependencies
- Build flags
- Upload settings
- Monitor configuration

#### `partitions.csv`
Custom partition table for ESP32 flash memory layout.

#### `build_and_flash.sh`
Shell script to automate full build process:
1. Build React dashboard
2. Copy to data/www
3. Build firmware
4. Upload filesystem
5. Upload firmware

#### `.gitignore`
Excludes build artifacts, node_modules, IDE files, etc.

### `/data/www/` - Web Dashboard Files

Contains the built React application that will be uploaded to LittleFS.

**Important**: This directory is auto-generated by the React build process. Do NOT edit files here directly.

### `/web-dashboard/` - React Source

#### Configuration Files

**`package.json`**
```json
{
  "name": "marine-gateway-dashboard",
  "version": "1.0.0",
  "type": "module",
  "scripts": {
    "dev": "vite",
    "build": "vite build",
    "preview": "vite preview"
  },
  "dependencies": {
    "react": "^18.2.0",
    "react-dom": "^18.2.0",
    "react-router-dom": "^6.20.0"
  },
  "devDependencies": {
    "@vitejs/plugin-react": "^4.2.0",
    "vite": "^5.0.0"
  }
}
```

**`vite.config.js`**
```javascript
import { defineConfig } from 'vite'
import react from '@vitejs/plugin-react'

export default defineConfig({
  plugins: [react()],
  build: {
    outDir: '../data/www',
    emptyOutDir: true,
    target: 'es2015',
    minify: 'terser',
    terserOptions: {
      compress: {
        drop_console: true,
        dead_code: true
      }
    },
    rollupOptions: {
      output: {
        manualChunks: undefined
      }
    },
    cssMinify: true,
    assetsInlineLimit: 4096
  }
})
```

**`build.sh`**
```bash
#!/bin/bash
set -e

echo "Building React dashboard..."
npm run build

echo "Dashboard built successfully to ../data/www/"
```

#### Source Structure

**`src/main.jsx`**
Entry point for React application.

**`src/App.jsx`**
Root component with routing and layout.

**`src/components/`**
Organized by feature/page:
- `Layout/` - Shell components (sidebar, header)
- `WiFi/` - WiFi configuration components
- `Serial/` - Serial port configuration components
- `NMEA/` - NMEA monitoring components
- `System/` - System status components

**`src/services/`**
API and WebSocket client code.

**`src/hooks/`**
Custom React hooks for shared logic.

### `/include/` - Header Files

#### `config.h`
Global configuration constants.

```cpp
#ifndef CONFIG_H
#define CONFIG_H

// WiFi
#define WIFI_CONNECT_TIMEOUT_MS  30000
#define WIFI_AP_SSID_PREFIX      "MarineGateway"
#define WIFI_AP_PASSWORD         "marine123"  // Default AP password

// UART
#define UART_NUM                 UART_NUM_1
#define UART_RX_PIN              GPIO_NUM_16
#define UART_TX_PIN              GPIO_NUM_17
#define UART_BUFFER_SIZE         2048
#define UART_DEFAULT_BAUD        38400

// TCP
#define TCP_PORT                 10110
#define TCP_MAX_CLIENTS          5

// Web Server
#define WEB_SERVER_PORT          80

// NMEA
#define NMEA_MAX_LENGTH          128
#define NMEA_QUEUE_SIZE          50

// NVS
#define NVS_NAMESPACE            "marine_gw"

// Task Priorities
#define TASK_PRIORITY_UART       5
#define TASK_PRIORITY_NMEA       4
#define TASK_PRIORITY_TCP        3
#define TASK_PRIORITY_WEB        3
#define TASK_PRIORITY_WIFI       2

// Task Stack Sizes
#define TASK_STACK_UART          4096
#define TASK_STACK_NMEA          4096
#define TASK_STACK_TCP           8192
#define TASK_STACK_WEB           8192
#define TASK_STACK_WIFI          4096

#endif
```

#### `types.h`
Common type definitions.

```cpp
#ifndef TYPES_H
#define TYPES_H

#include <stdint.h>

// WiFi configuration structure
struct WiFiConfig {
    char ssid[32];
    char password[64];
    uint8_t mode;  // 0=STA, 1=AP
};

// Serial configuration structure
struct SerialConfig {
    uint32_t baudRate;
    uint8_t dataBits;  // 5-8
    uint8_t parity;    // 0=None, 1=Even, 2=Odd
    uint8_t stopBits;  // 1-2
};

// NMEA sentence structure
struct NMEASentence {
    char raw[128];
    char type[8];
    uint8_t checksum;
    bool valid;
    uint32_t timestamp;
};

// WiFi state enumeration
enum WiFiState {
    WIFI_DISCONNECTED,
    WIFI_CONNECTING,
    WIFI_CONNECTED_STA,
    WIFI_AP_MODE
};

#endif
```

#### Other Headers
- `uart_handler.h` - UART communication class interface
- `nmea_parser.h` - NMEA parsing and validation
- `tcp_server.h` - TCP server for NMEA streaming
- `web_server.h` - HTTP server and WebSocket
- `config_manager.h` - NVS-based configuration storage
- `wifi_manager.h` - WiFi connection management

### `/src/` - Implementation Files

#### `main.cpp`
Application entry point. Contains:
- `setup()` function
- FreeRTOS task creation
- Main loop
- Global object instances

**Structure**:
```cpp
#include <Arduino.h>
#include "config.h"
#include "uart_handler.h"
#include "nmea_parser.h"
#include "tcp_server.h"
#include "web_server.h"
#include "config_manager.h"
#include "wifi_manager.h"

// Global instances
ConfigManager configManager;
WiFiManager wifiManager;
UARTHandler uartHandler;
NMEAParser nmeaParser;
TCPServer tcpServer;
WebServer webServer;

// FreeRTOS task handles
TaskHandle_t uartTaskHandle;
TaskHandle_t nmeaTaskHandle;
TaskHandle_t wifiTaskHandle;

// Task functions
void uartTask(void* parameter);
void nmeaTask(void* parameter);
void wifiTask(void* parameter);

void setup() {
    // Initialize Serial for debugging
    Serial.begin(115200);
    
    // Initialize components
    configManager.init();
    
    WiFiConfig wifiConfig;
    configManager.getWiFiConfig(wifiConfig);
    wifiManager.init(wifiConfig);
    
    SerialConfig serialConfig;
    configManager.getSerialConfig(serialConfig);
    uartHandler.init(serialConfig);
    
    tcpServer.init(TCP_PORT);
    webServer.init();
    
    // Create tasks
    xTaskCreate(uartTask, "UART", TASK_STACK_UART, 
                NULL, TASK_PRIORITY_UART, &uartTaskHandle);
    xTaskCreate(nmeaTask, "NMEA", TASK_STACK_NMEA, 
                NULL, TASK_PRIORITY_NMEA, &nmeaTaskHandle);
    xTaskCreate(wifiTask, "WiFi", TASK_STACK_WIFI, 
                NULL, TASK_PRIORITY_WIFI, &wifiTaskHandle);
    
    // Start services
    wifiManager.start();
    uartHandler.start();
    tcpServer.start();
    webServer.start();
}

void loop() {
    // Main loop can be empty (tasks handle everything)
    vTaskDelay(pdMS_TO_TICKS(1000));
}
```

#### Other Implementation Files
Each `.cpp` file implements the corresponding `.h` header:
- `uart_handler.cpp` - UART RX handling, ring buffer
- `nmea_parser.cpp` - Line parsing, checksum validation
- `tcp_server.cpp` - Client management, broadcasting
- `web_server.cpp` - HTTP routes, WebSocket handlers
- `config_manager.cpp` - NVS read/write operations
- `wifi_manager.cpp` - Connection logic, state machine

## Build Artifacts (Not in Git)

These directories are generated during build and should be in `.gitignore`:

```
.pio/                   # PlatformIO build cache
.vscode/                # VS Code settings (generated by PlatformIO)
web-dashboard/dist/     # React build output
web-dashboard/node_modules/  # NPM dependencies
data/www/               # Copied from web-dashboard/dist/
```

## Configuration Files for IDE

### `.vscode/extensions.json` (Optional)
```json
{
    "recommendations": [
        "platformio.platformio-ide"
    ]
}
```

### `.vscode/settings.json` (Generated by PlatformIO)
```json
{
    "files.associations": {
        "*.h": "cpp",
        "*.cpp": "cpp"
    },
    "C_Cpp.default.configurationProvider": "platformio.platformio-ide"
}
```

## Git Ignore Template

### `.gitignore`
```gitignore
# PlatformIO
.pio/
.vscode/

# React
web-dashboard/node_modules/
web-dashboard/dist/

# Build output
data/www/

# OS
.DS_Store
Thumbs.db

# IDE
*.swp
*.swo
*~
.idea/

# Logs
*.log

# Environment
.env
```

## Library Dependencies

Managed in `platformio.ini`:

```ini
lib_deps = 
    me-no-dev/ESPAsyncWebServer@^1.2.3
    me-no-dev/AsyncTCP@^1.1.1
    bblanchon/ArduinoJson@^7.0.0
```

These libraries will be automatically downloaded by PlatformIO.

## Size Estimates

| Component | Approximate Size |
|-----------|------------------|
| Firmware binary | ~800KB - 1.2MB |
| Web dashboard (built) | ~350KB uncompressed, ~120KB gzipped |
| Total LittleFS usage | ~400KB (with room for growth) |
| NVS configuration | ~2KB actual data |

## Development Workflow

1. **Edit firmware**: Modify files in `src/` and `include/`
2. **Edit dashboard**: Modify files in `web-dashboard/src/`
3. **Build dashboard**: `cd web-dashboard && npm run build`
4. **Build firmware**: `pio run`
5. **Upload all**: `./build_and_flash.sh` (one command for everything)

## Modular Design Benefits

- **Separation of concerns**: Each module has a single responsibility
- **Testability**: Individual components can be unit tested
- **Maintainability**: Easy to locate and modify specific functionality
- **Extensibility**: Add new features without modifying existing code
- **Code reuse**: Components can be used in multiple contexts
